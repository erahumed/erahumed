<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation workflow â€¢ erahumed</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">erahumed</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.21.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/erahumed-workflow.html">Simulation workflow</a></li>
    <li><a class="dropdown-item" href="../articles/rfms.html">Designing custom agrochemical scenarios</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/erahumed/erahumed/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/erahumed/erahumed/blob/master/vignettes/erahumed-workflow.Rmd" class="external-link"><code>vignettes/erahumed-workflow.Rmd</code></a></small>
      <div class="d-none name"><code>erahumed-workflow.Rmd</code></div>
    </div>

    
    
<p>This document illustrates the basic simulation workflow of ERAHUMED.
Specifically, we will cover:</p>
<ul>
<li>How to setup and run a simulation.</li>
<li>How to extract and analyze simulation results.</li>
</ul>
<p>The goal is to provide a practical, step-by-step overview of how to
perform simulations. For a detailed explanation of the underlying
models, algorithms, and assumptions, refer to the <a href="https://erahumed.github.io/erahumed-book/">user manual</a>.</p>
<p>This guide is intended for users working with the R interface of the
package and is not required for those using only the Shiny GUI.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/erahumed/erahumed" class="external-link">erahumed</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="running-a-simulation">Running a simulation<a class="anchor" aria-label="anchor" href="#running-a-simulation"></a>
</h2>
<p>The main interface for running simulations in <a href="https://github.com/erahumed/erahumed" class="external-link">erahumed</a>
is the <code><a href="../reference/erahumed_simulation.html">erahumed_simulation()</a></code> function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/erahumed_simulation.html">erahumed_simulation</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initializing inputs</span></span>
<span><span class="co">#&gt; Computing hydrology: lake</span></span>
<span><span class="co">#&gt; Computing hydrology: clusters</span></span>
<span><span class="co">#&gt; Computing hydrology: ditches</span></span>
<span><span class="co">#&gt; Computing exposure: clusters</span></span>
<span><span class="co">#&gt; Computing exposure: ditches</span></span>
<span><span class="co">#&gt; Computing exposure: lake</span></span>
<span><span class="co">#&gt; Computing risk: clusters</span></span>
<span><span class="co">#&gt; Computing risk: ditches</span></span>
<span><span class="co">#&gt; Computing risk: lake</span></span>
<span><span class="va">sim</span></span>
<span><span class="co">#&gt; &lt;ERAHUMED Simulation&gt;</span></span>
<span><span class="co">#&gt;   Date range             : 2020-01-01 to 2020-12-31 </span></span>
<span><span class="co">#&gt;   Simulation days        : 366 </span></span>
<span><span class="co">#&gt;   Clusters               : 552 </span></span>
<span><span class="co">#&gt;   Management systems     : 2 </span></span>
<span><span class="co">#&gt;   Chemicals simulated    : 8 </span></span>
<span><span class="co">#&gt;   Total applications     : 17</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Need help extracting simulation outputs? Check `?get_results`.</span></span></code></pre></div>
<p>This function handles both the <em>setup</em> and <em>execution</em>
of a simulation. Simulation parameters are specified via its arguments,
and calling the function launches the simulation and returns a fully
executed object containing the results (note that this may take some
time).</p>
<p>The example above runs a simulation with the default model
parameters. These can be customized via the arguments of
<code><a href="../reference/erahumed_simulation.html">erahumed_simulation()</a></code>. For instance:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/erahumed_simulation.html">erahumed_simulation</a></span><span class="op">(</span>foc_ss <span class="op">=</span> <span class="fl">0.20</span>, foc_sed <span class="op">=</span> <span class="fl">0.07</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initializing inputs</span></span>
<span><span class="co">#&gt; Computing hydrology: lake</span></span>
<span><span class="co">#&gt; Computing hydrology: clusters</span></span>
<span><span class="co">#&gt; Computing hydrology: ditches</span></span>
<span><span class="co">#&gt; Computing exposure: clusters</span></span>
<span><span class="co">#&gt; Computing exposure: ditches</span></span>
<span><span class="co">#&gt; Computing exposure: lake</span></span>
<span><span class="co">#&gt; Computing risk: clusters</span></span>
<span><span class="co">#&gt; Computing risk: ditches</span></span>
<span><span class="co">#&gt; Computing risk: lake</span></span>
<span><span class="va">sim2</span></span>
<span><span class="co">#&gt; &lt;ERAHUMED Simulation&gt;</span></span>
<span><span class="co">#&gt;   Date range             : 2020-01-01 to 2020-12-31 </span></span>
<span><span class="co">#&gt;   Simulation days        : 366 </span></span>
<span><span class="co">#&gt;   Clusters               : 552 </span></span>
<span><span class="co">#&gt;   Management systems     : 2 </span></span>
<span><span class="co">#&gt;   Chemicals simulated    : 8 </span></span>
<span><span class="co">#&gt;   Total applications     : 17</span></span></code></pre></div>
<p>runs a simulation with modified environmental parameters (fraction of
organic content in suspended solid and sediment), while:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/erahumed_simulation.html">erahumed_simulation</a></span><span class="op">(</span>date_start <span class="op">=</span> <span class="st">"2019-01-01"</span>, date_end <span class="op">=</span> <span class="st">"2019-12-31"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initializing inputs</span></span>
<span><span class="co">#&gt; Computing hydrology: lake</span></span>
<span><span class="co">#&gt; Computing hydrology: clusters</span></span>
<span><span class="co">#&gt; Computing hydrology: ditches</span></span>
<span><span class="co">#&gt; Computing exposure: clusters</span></span>
<span><span class="co">#&gt; Computing exposure: ditches</span></span>
<span><span class="co">#&gt; Computing exposure: lake</span></span>
<span><span class="co">#&gt; Computing risk: clusters</span></span>
<span><span class="co">#&gt; Computing risk: ditches</span></span>
<span><span class="co">#&gt; Computing risk: lake</span></span>
<span><span class="va">sim3</span></span>
<span><span class="co">#&gt; &lt;ERAHUMED Simulation&gt;</span></span>
<span><span class="co">#&gt;   Date range             : 2019-01-01 to 2019-12-31 </span></span>
<span><span class="co">#&gt;   Simulation days        : 365 </span></span>
<span><span class="co">#&gt;   Clusters               : 552 </span></span>
<span><span class="co">#&gt;   Management systems     : 2 </span></span>
<span><span class="co">#&gt;   Chemicals simulated    : 8 </span></span>
<span><span class="co">#&gt;   Total applications     : 17</span></span></code></pre></div>
<p>runs a simulation over a different date range.</p>
<p>The full set of simulation parameters is documented in <a href="https://erahumed.github.io/erahumed-book/chapters/model-inputs.html">the
user manual</a>, as well as in the R documentation page
<code><a href="../reference/erahumed_simulation.html">?erahumed_simulation</a></code>. We highlight a few special
parameters:</p>
<ul>
<li><p><strong>Observational inputs</strong> - The
<code>outflows_df</code> and <code>weather_df</code> arguments of
<code><a href="../reference/erahumed_simulation.html">erahumed_simulation()</a></code> are data-frames containing
time-series data that serve as the empirical basis for ERAHUMED
simulations. Further details are provided in the <a href="https://erahumed.github.io/erahumed-book/chapters/model-inputs.html#observational-inputs-hydrology-and-weather">user
manual</a>. The <code>date_start</code> and <code>date_end</code>
arguments (see above) must fall within the time range covered by these
datasets.</p></li>
<li><p><strong>Rice-field (agrochemical) management system map</strong>
- The <code>rfms_map</code> argument argument is the primary interface
for advanced scenario customization, encapsulating the full set of
user-defined agrochemical configurations (including custom chemicals and
Rice-Field Management Systems, or RFMSs). A conceptual overview of these
capabilities is provided in the <a href="https://erahumed.github.io/erahumed-book/chapters/rfms.html">user
manual</a>, while a step-by-step guide to creating custom scenarios is
available in a <a href="https://erahumed.github.io/erahumed/articles/rfms">dedicated
vignette</a>.</p></li>
<li><p><strong>Random seed</strong> - The <code>seed</code> argument
controls the random number generator used in the simulation, ensuring
reproducible results when stochastic elements are involved (e.g., the
random order in which rice field clusters are drained during the sowing
season). Setting a fixed value allows you to obtain identical results
when re-running the same simulation; leaving it unset may produce
slightly different outcomes across runs.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="analyzing-simulation-results">Analyzing simulation results<a class="anchor" aria-label="anchor" href="#analyzing-simulation-results"></a>
</h2>
<p>Simulation results are extracted as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lake_hydrology_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_results.html">get_results</a></span><span class="op">(</span><span class="va">sim</span>, component <span class="op">=</span> <span class="st">"hydrology"</span>, element <span class="op">=</span> <span class="st">"lake"</span><span class="op">)</span></span>
<span><span class="va">cluster_hydrology_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_results.html">get_results</a></span><span class="op">(</span><span class="va">sim</span>, component <span class="op">=</span> <span class="st">"hydrology"</span>, element <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span></span>
<span><span class="va">cluster_exposure_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_results.html">get_results</a></span><span class="op">(</span><span class="va">sim</span>, component <span class="op">=</span> <span class="st">"exposure"</span>, element <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span></span></code></pre></div>
<p>These are provided in the form of <code>data.frame</code>s, for
instance:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cluster_hydrology_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;         date                element_id   area_m2 is_tancat outflow_m3</span></span>
<span><span class="co">#&gt; 1 2020-01-01 02_Carrera_del_Saler0-2_0 114881.78      TRUE          0</span></span>
<span><span class="co">#&gt; 2 2020-01-01          03_Petxinar0-3_2 116539.90      TRUE          0</span></span>
<span><span class="co">#&gt; 3 2020-01-01          03_Petxinar0-3_3 154730.35      TRUE          0</span></span>
<span><span class="co">#&gt; 4 2020-01-01          03_Petxinar1-3_1 163789.56      TRUE          0</span></span>
<span><span class="co">#&gt; 5 2020-01-01          03_Petxinar1-3_2  83016.51      TRUE          0</span></span>
<span><span class="co">#&gt; 6 2020-01-01          03_Petxinar1-3_3 106260.07      TRUE          0</span></span>
<span><span class="co">#&gt;   outflow_cm inflow_m3 inflow_cm volume_m3 depth_cm petp_cm</span></span>
<span><span class="co">#&gt; 1          0  66.63143     0.058  22976.36       20  -0.058</span></span>
<span><span class="co">#&gt; 2          0  67.59314     0.058  23307.98       20  -0.058</span></span>
<span><span class="co">#&gt; 3          0  89.74360     0.058  30946.07       20  -0.058</span></span>
<span><span class="co">#&gt; 4          0  94.99795     0.058  32757.91       20  -0.058</span></span>
<span><span class="co">#&gt; 5          0  48.14958     0.058  16603.30       20  -0.058</span></span>
<span><span class="co">#&gt; 6          0  61.63084     0.058  21252.01       20  -0.058</span></span></code></pre></div>
<p>From here on, the analysis may proceed in the way you find more
convenient. For instance, in the chunk below I create a plot of water
levels for the whole set of rice field clusters, using
<code>dplyr</code> and <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">clusters_df</span> <span class="op">&lt;-</span> <span class="va">cluster_hydrology_df</span></span>
<span></span>
<span><span class="va">avg_df</span> <span class="op">&lt;-</span> <span class="va">clusters_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>depth_cm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">depth_cm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">clusters_df</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">depth_cm</span>, group <span class="op">=</span> <span class="va">element_id</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">avg_df</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">depth_cm</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Date"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Depth [cm]"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Cluster simulated water levels"</span><span class="op">)</span></span></code></pre></div>
<p><img src="erahumed-workflow_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="further-information">Further information<a class="anchor" aria-label="anchor" href="#further-information"></a>
</h2>
<p>For additional details not covered in this guide, see the <a href="https://erahumed.github.io/erahumed/articles/">other package
vignettes</a>. If there is a specific topic you would like to see
documented, please let us know by <a href="https://github.com/erahumed/erahumed/issues" class="external-link">filing an issue on
GitHub</a> or by using the contact information provided on the <a href="https://erahumed.github.io/erahumed/index.html">package
homepage</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Valerio Gherardi, Pablo Amador.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
