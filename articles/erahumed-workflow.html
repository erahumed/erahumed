<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation workflow • erahumed</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">erahumed</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.16.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ct-diagram.html">Diagram of physical processes for chemical transport</a></li>
    <li><a class="dropdown-item" href="../articles/erahumed-workflow.html">Simulation workflow</a></li>
    <li><a class="dropdown-item" href="../articles/hydrology-scheme.html">Hydrological model of the Albufera Natural Park</a></li>
    <li><a class="dropdown-item" href="../articles/pipeline-scheme.html">Scheme of the simulation pipeline</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/erahumed/erahumed/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/erahumed/erahumed/blob/v0.16.0/vignettes/erahumed-workflow.Rmd" class="external-link"><code>vignettes/erahumed-workflow.Rmd</code></a></small>
      <div class="d-none name"><code>erahumed-workflow.Rmd</code></div>
    </div>

    
    
<p>This document illustrates the simulation workflow of ERAHUMED.
Specifically, we will cover:</p>
<ul>
<li>How to setup and run a simulation.</li>
<li>How to extract and analyze simulation results.</li>
</ul>
<p>This guide is addressed to users working with the command-line
(<em>i.e.</em> R) interface of <a href="https://github.com/erahumed/erahumed" class="external-link">erahumed</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/erahumed/erahumed" class="external-link">erahumed</a></span><span class="op">)</span></span></code></pre></div>
<p>We initialize a new ERAHUMED simulation with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/erahumed_simulation.html">erahumed_simulation</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span></span>
<span><span class="co">#&gt; An ERAHUMED simulation.</span></span>
<span><span class="co">#&gt; Computed layers: None</span></span></code></pre></div>
<p>At this stage, <code>sim</code> is simply a list of simulation
parameters, all initialized to their default values. To customize these
parameters, we use <code><a href="../reference/erahumed_parameters.html">setup_hydrology()</a></code>,
<code><a href="../reference/erahumed_parameters.html">setup_exposure()</a></code>, and <code><a href="../reference/erahumed_parameters.html">setup_risk()</a></code>. These
functions provide access to the specific subset of parameters associated
with the hydrology, exposure, or risk components of the simulation,
respectively. For instance, the following command modifies the “height
threshold” numeric parameter and provides a custom
<code>outflows_df</code> input data-set with a reduced date range (see
<code><a href="../reference/erahumed_parameters.html">?setup_hydrology</a></code> for the detailed documentation of these
parameters):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outflows_df</span> <span class="op">&lt;-</span> <span class="va">albufera_outflows</span> <span class="op">|&gt;</span></span>
<span>  <span class="op">(</span>\<span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="va">.</span><span class="op">[</span><span class="st">"2020-01-01"</span> <span class="op">&lt;=</span> <span class="va">.</span><span class="op">$</span><span class="va">date</span> <span class="op">&amp;</span> <span class="va">.</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="st">"2020-12-31"</span>, <span class="op">]</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/erahumed_parameters.html">setup_hydrology</a></span><span class="op">(</span>height_thresh_cm <span class="op">=</span> <span class="fl">1</span>, outflows_df <span class="op">=</span> <span class="va">outflows_df</span><span class="op">)</span></span></code></pre></div>
<p>Once we are ready with our simulation setup, in order to actually run
the simulation we use:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/run_simulation.html">run_simulation</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span></span>
<span><span class="co">#&gt; An ERAHUMED simulation.</span></span>
<span><span class="co">#&gt; Computed layers: inp, hbl, hbc, hbd, ca, ctc, ctd, ctl, rc, rd, rl</span></span></code></pre></div>
<p>In order to extract simulation results we use:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lake_hydrology_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_results.html">get_results</a></span><span class="op">(</span><span class="va">sim</span>, component <span class="op">=</span> <span class="st">"hydrology"</span>, element <span class="op">=</span> <span class="st">"lake"</span><span class="op">)</span></span>
<span><span class="va">cluster_hydrology_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_results.html">get_results</a></span><span class="op">(</span><span class="va">sim</span>, component <span class="op">=</span> <span class="st">"hydrology"</span>, element <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span></span>
<span><span class="va">cluster_exposure_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_results.html">get_results</a></span><span class="op">(</span><span class="va">sim</span>, component <span class="op">=</span> <span class="st">"exposure"</span>, element <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span></span></code></pre></div>
<p>These are provided in the form of <code>data.frame</code>s, for
instance:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cluster_hydrology_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ideal_height_eod_cm ideal_irrigation ideal_draining petp_cm   area_m2</span></span>
<span><span class="co">#&gt; 1                  20             TRUE           TRUE  -0.058 114881.78</span></span>
<span><span class="co">#&gt; 2                  20             TRUE           TRUE  -0.058 116539.90</span></span>
<span><span class="co">#&gt; 3                  20             TRUE           TRUE  -0.058 154730.35</span></span>
<span><span class="co">#&gt; 4                  20             TRUE           TRUE  -0.058 163789.56</span></span>
<span><span class="co">#&gt; 5                  20             TRUE           TRUE  -0.058  83016.51</span></span>
<span><span class="co">#&gt; 6                  20             TRUE           TRUE  -0.058 106260.07</span></span>
<span><span class="co">#&gt;   capacity_m3_s       date                cluster_id ditch seed_day tancat</span></span>
<span><span class="co">#&gt; 1    0.03448408 2020-01-01 02_Carrera_del_Saler0-2_0    d2     -110   TRUE</span></span>
<span><span class="co">#&gt; 2    0.03448408 2020-01-01          03_Petxinar0-3_2    d2     -110   TRUE</span></span>
<span><span class="co">#&gt; 3    0.03448408 2020-01-01          03_Petxinar0-3_3    d2     -110   TRUE</span></span>
<span><span class="co">#&gt; 4    0.03448408 2020-01-01          03_Petxinar1-3_1    d2     -110   TRUE</span></span>
<span><span class="co">#&gt; 5    0.03448408 2020-01-01          03_Petxinar1-3_2    d2     -110   TRUE</span></span>
<span><span class="co">#&gt; 6    0.03448408 2020-01-01          03_Petxinar1-3_3    d2     -110   TRUE</span></span>
<span><span class="co">#&gt;      variety height_sod_cm irrigation draining ideal_diff_flow_cm</span></span>
<span><span class="co">#&gt; 1      Bomba            20       TRUE     TRUE              0.058</span></span>
<span><span class="co">#&gt; 2 Clearfield            20       TRUE     TRUE              0.058</span></span>
<span><span class="co">#&gt; 3 Clearfield            20       TRUE     TRUE              0.058</span></span>
<span><span class="co">#&gt; 4   J.Sendra            20       TRUE     TRUE              0.058</span></span>
<span><span class="co">#&gt; 5   J.Sendra            20       TRUE     TRUE              0.058</span></span>
<span><span class="co">#&gt; 6 Clearfield            20       TRUE     TRUE              0.058</span></span>
<span><span class="co">#&gt;   ideal_inflow_cm ideal_outflow_cm outflow_m3_s outflow_cm inflow_cm</span></span>
<span><span class="co">#&gt; 1               5            4.942            0          0     0.058</span></span>
<span><span class="co">#&gt; 2               5            4.942            0          0     0.058</span></span>
<span><span class="co">#&gt; 3               5            4.942            0          0     0.058</span></span>
<span><span class="co">#&gt; 4               5            4.942            0          0     0.058</span></span>
<span><span class="co">#&gt; 5               5            4.942            0          0     0.058</span></span>
<span><span class="co">#&gt; 6               5            4.942            0          0     0.058</span></span>
<span><span class="co">#&gt;    inflow_m3_s height_eod_cm plan_delay</span></span>
<span><span class="co">#&gt; 1 0.0007711971            20          0</span></span>
<span><span class="co">#&gt; 2 0.0007823281            20          0</span></span>
<span><span class="co">#&gt; 3 0.0010386991            20          0</span></span>
<span><span class="co">#&gt; 4 0.0010995133            20          0</span></span>
<span><span class="co">#&gt; 5 0.0005572868            20          0</span></span>
<span><span class="co">#&gt; 6 0.0007133199            20          0</span></span></code></pre></div>
<p>From here on, the analysis may proceed in the way you find more
convenient. For instance, in the chunk below I create a plot of water
levels for a set of clusters with similar features, using
<code>dplyr</code> and <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ditch</span> <span class="op">&lt;-</span> <span class="st">"d4"</span></span>
<span><span class="va">tancat</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">variety</span> <span class="op">&lt;-</span> <span class="st">"Clearfield"</span></span>
<span></span>
<span><span class="va">clusters_df</span> <span class="op">&lt;-</span> <span class="va">cluster_hydrology_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ditch</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">ditch</span>, <span class="va">tancat</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">tancat</span>, <span class="va">variety</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">variety</span><span class="op">)</span></span>
<span></span>
<span><span class="va">avg_df</span> <span class="op">&lt;-</span> <span class="va">clusters_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>height_eod_cm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">height_eod_cm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">clusters_df</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">height_eod_cm</span>, group <span class="op">=</span> <span class="va">cluster_id</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">avg_df</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">height_eod_cm</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Date"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Height [cm]"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Cluster simulated water levels"</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Ditch:"</span>, <span class="va">ditch</span>, <span class="st">"- Tancat:"</span>, <span class="va">tancat</span>, <span class="st">"- Variety:"</span>, <span class="va">variety</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span></code></pre></div>
<p><img src="erahumed-workflow_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="section level2">
<h2 id="further-information">Further information<a class="anchor" aria-label="anchor" href="#further-information"></a>
</h2>
<p>Further details will appear in this and possibly other vignettes. For
specific problems, you can <a href="https://github.com/erahumed/erahumed/issues" class="external-link">file an issue on
Github</a>.</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Valerio Gherardi, Pablo Amador.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
